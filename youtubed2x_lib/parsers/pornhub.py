import re
import datetime
from youtubed2x_lib.parsers import Parser_Helper, getPage


class Pornhub_Parser (Parser_Helper):
    """Parser for Pornhub pages. Updated 01/07/2009"""
    const_video_url_re = re.compile (r'^(?:http://)?(?:www\.)?pornhub\.com/view_video.php\?viewkey=(\w+)$')
    domain_str = "http://www.pornhub.com/"
    video_url_str = 'http://www.pornhub.com/view_video.php?viewkey=%s'
    video_title_re = re.compile (r'<title>([^<]*) - Pornhub.com</title>')
    video_url_params_re = re.compile (r'to\.addVariable\("options", "(\S+)"\);')
    video_key_re = re.compile (r"<flv_url>(\S+)</flv_url>")
    parser_type = "Pornhub"
    host_str = "pornhub.com"
    version = datetime.date (2009, 1, 7)


    def _parseRealURL (self, commands):
        """Get the real url for the video"""
        from urllib2 import unquote
        video_config_url = unquote (commands[0])
        page, newurl = getPage (video_config_url)
        match = self.video_key_re.search (page)
        if not match:
            raise self.URLBuildFailed ("Could not find video url or position key")
        else:
            secondary_url = match.group (1)

        # Follow redirect
        page, real_url = getPage (secondary_url, read_page=False)
        return real_url

    @staticmethod
    def getImageData ():
        image_data = """\xde\xde\xde\xffHHH\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xffHHH\xff\xde\xde\xde\xffHHH\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xffHHH\xff\x1e\x1e\x1e\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff\x10\x06\x00\xff\x7f3\x00\xff\x7f3\x00\xff\x7f3\x00\xff0\x13\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff`&\x00\xff\x7f3\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff \r\x00\xff\x7f3\x00\xff@\x1a\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff@\x1a\x00\xff\xfef\x00\xff\xdeY\x00\xff\xceS\x00\xff\xfef\x00\xff\x7f3\x00\xff\x00\x00\x00\xff\xbeL\x00\xff\xfef\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x00\x00\x00\xff\xceS\x00\xff\xdeY\x00\xff\x00\x00\x00\xff\xbeL\x00\xff\xfef\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x10\x06\x00\xff\xdeY\x00\xff\xceS\x00\xff\x00\x00\x00\xff\xbeL\x00\xff\xfef\x00\xff\x7f3\x00\xff\x7f3\x00\xff\x9e@\x00\xff\xfef\x00\xff\x7f3\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff@\x1a\x00\xff\xfef\x00\xff\xfef\x00\xff\xfef\x00\xff\xdeY\x00\xff0\x13\x00\xff\x00\x00\x00\xff\xbeL\x00\xff\xfef\x00\xff\xfef\x00\xff\xfef\x00\xff\xfef\x00\xff\xfef\x00\xff\x7f3\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff@\x1a\x00\xff\xfef\x00\xff\x9e@\x00\xff0\x13\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\xbeL\x00\xff\xfef\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\xbeL\x00\xff\xfef\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\xbeL\x00\xff\xfef\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff@\x1a\x00\xff\xfef\x00\xff\x7f3\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x1e\x1e\x1e\xff\x1e\x1e\x1e\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x1e\x1e\x1e\xffHHH\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xff\x00\x00\x00\xffHHH\xff\xdb\xdb\xdb\xffBBB\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xff333\xffEEE\xff\xdb\xdb\xdb\xff"""

        return image_data


